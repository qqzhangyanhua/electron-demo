"use strict";const t=require("electron"),w=require("path"),u=require("fs"),{exec:a}=require("child_process"),m=require("node-schedule");let h,l;const E=()=>{const o=new t.BrowserWindow({width:900,height:600,minHeight:600,minWidth:900,icon:w.resolve(__dirname,"../favicon.ico"),webPreferences:{nodeIntegration:!0,contextIsolation:!1,webSecurity:!1},autoHideMenuBar:!0});h=o,process.env.VITE_DEV_SERVER_URL?o.loadURL(process.env.VITE_DEV_SERVER_URL):o.loadFile(w.resolve(__dirname,"../dist/index.html"))},$=()=>{const{width:o,height:e}=t.screen.getPrimaryDisplay().workAreaSize,n=new t.BrowserWindow({width:350,height:350,icon:w.resolve(__dirname,"../favicon.ico"),frame:!1,alwaysOnTop:!0,transparent:!0,show:!1});l=n,n.loadURL("https://www.zyh.show/?code=1"),console.log("width",o),console.log("height",e),l.setPosition(o-360,e-320)};t.app.whenReady().then(()=>{E(),$()});t.app.on("window-all-closed",()=>{h=null,process.platform!="darwin"&&t.app.quit()});t.app.on("activate",()=>{console.log("BrowserWindow.getAllWindows",h),h===null&&E()});t.ipcMain.on("make-window",o=>{if(console.log("创建窗口=======",l.isVisible()),l&&!l.isVisible()){l.show();return}else l.hide()});t.ipcMain.on("open-folder",(o,e)=>{t.dialog.showOpenDialog({properties:["openDirectory"]}).then(n=>{if(n.canceled)return;const r=u.readdirSync(n.filePaths[0]),s=n.filePaths[0];console.log("路径前缀===",s);const i=[];for(const c of r){const d=w.join(s,c);u.statSync(d).isDirectory()&&i.push({filePath:d,fileName:c})}console.log("directoryList",i),u.writeFile("data.json",JSON.stringify(i),c=>{if(c){console.error(c);return}console.log("Data written to file")}),o.sender.send("directoryList",i)})});t.ipcMain.on("scriptExe",(o,e)=>{console.log("scriptExe==================",e),e.type==="vscode"&&a(` /usr/local/bin/code ${e.filePath}`,(r,s,i)=>{if(r){console.error(`exec error: ${r}`);return}}),e.type==="finder"&&a(`open ${e.filePath}`,(n,r,s)=>{if(n){console.error(`exec error: ${n}`);return}}),e.type==="iterm"&&a(`cd ${e.filePath} && open -a iTerm .`,(n,r,s)=>{if(n){console.error(`exec error: ${n}`);return}})});let f;t.ipcMain.on("setAlarm",(o,e)=>{console.log("setAlarm==================",e),console.log("job===",f),f&&f.cancel(),f=m.scheduleJob(new Date(e.time),function(){o.sender.send("alarmTriggered");var n=new t.Notification({title:e.title,body:e.body});n.show()})});t.ipcMain.on("reminderEvent",(o,e)=>{g(e)});t.ipcMain.on("reminderEvent2",(o,e)=>{g(e)});t.ipcMain.on("reminderEvent1",(o,e)=>{g(e)});t.ipcMain.on("open-file-dialog",(o,e)=>{console.log("open-file-dialog==================",e),t.dialog.showOpenDialog({properties:["openFile","openDirectory"]}).then(n=>{console.log("res",n),o.reply("selected-directory",n),o.sender.send("directoryList",n.filePaths[0])})});t.ipcMain.on("git-clone",(o,e)=>{console.log("git-clone==================",e);const n=`${e.filePath}/${e.projectName}`,s=`git clone ${e.template} ${n}`;a(s,(i,c,d)=>{if(i){console.error(`exec error: ${i}`);return}console.log(`stdout: ${c}`),o.sender.send("clone-success",e),console.error(`clone-success: ${d}`);const y=`cd ${n} && git remote remove origin`;a(y,(v,b,P)=>{if(v){console.error(`exec error: ${v}`);return}console.error("远程地址已经删除===")})})});const p={reminderEvent:null,reminderEvent1:null,reminderEvent2:null};function g(o){if(console.log("setAlarm==================",o),o.action==="cancel"){p[o.eventKey].cancel();return}p[o.eventKey]&&p[o.eventKey].cancel(),p[o.eventKey]=m.scheduleJob(new Date(o.time),function(){var e=new t.Notification({title:o.title,body:o.body});e.show()})}
